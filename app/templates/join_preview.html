{% extends "base.html" %}
{% block title %}DS-PAL - Join Preview{% endblock %}
{% block content %}
<section>
    <h2>Join Preview</h2>

    <p><strong>{{ num_rows }}</strong> rows &times; <strong>{{ num_columns }}</strong> columns</p>

    <details open>
        <summary>Columns</summary>
        <p>{{ columns|join(", ") }}</p>
    </details>

    <figure>
        <table role="grid">
            <thead>
                <tr>
                    {% for col in columns %}
                    <th>{{ col }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for row in sample_rows %}
                <tr>
                    {% for col in columns %}
                    <td>{{ row[col] if row[col] is not none else "" }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </figure>

    <div class="grid">
        <form method="post" action="/dataset/upload/{{ upload_id }}/join">
            <input type="hidden" name="name" value="{{ name }}">
            <input type="hidden" name="action" value="confirm">
            <input type="hidden" name="sheet_configs_json" value='{{ sheet_configs_json }}'>
            {% set configs = sheet_configs_json | tojson %}
            {# Re-emit the sheet config as hidden fields for _parse_join_form #}
            <div id="join-config-fields"></div>
            <button type="submit">Proceed to Analysis</button>
        </form>
        <a href="/dataset/upload/{{ upload_id }}/sheets?name={{ name }}" role="button" class="secondary">Back &mdash; Adjust Join</a>
    </div>
</section>

<script>
// Re-emit join config as hidden form fields from the JSON
(function() {
    var configs = {{ sheet_configs_json | safe }};
    var container = document.getElementById("join-config-fields");
    configs.forEach(function(cfg, i) {
        var inp = document.createElement("input");
        inp.type = "hidden"; inp.name = "sheet_" + i; inp.value = cfg.name;
        container.appendChild(inp);
        if (i > 0) {
            var keyInp = document.createElement("input");
            keyInp.type = "hidden"; keyInp.name = "join_key_" + i; keyInp.value = cfg.join_key;
            container.appendChild(keyInp);
            var typeInp = document.createElement("input");
            typeInp.type = "hidden"; typeInp.name = "join_type_" + i; typeInp.value = cfg.join_type;
            container.appendChild(typeInp);
        }
    });
})();
</script>
{% endblock %}
