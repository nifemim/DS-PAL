<h2>{{ analysis.title }}</h2>

{% if analysis.encoding_info %}
<details open>
    <summary><strong>Column Transformations Applied</strong></summary>
    <ul>
        {% for enc in analysis.encoding_info %}
        <li><strong>{{ enc.original_column }}</strong>: {{ enc.encoding_type }} encoding
            ({{ enc.cardinality }} categories{% if enc.new_columns|length > 1 %} &rarr; {{ enc.new_columns|length }} features{% endif %})
            {% if enc.encoding_type == "label" %}
            <em>&mdash; assumes ordinal order</em>
            {% endif %}
        </li>
        {% endfor %}
    </ul>
</details>
{% endif %}

{% if insights_enabled %}
<article id="cluster-insights"
         hx-get="/api/analysis/{{ analysis.id }}/insights"
         hx-trigger="load"
         hx-swap="innerHTML">
    <p aria-busy="true">Generating insights...</p>
</article>
{% endif %}

<!-- Summary stats -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="value">{{ analysis.n_clusters }}</div>
        <div class="label">Clusters Found</div>
    </div>
    <div class="stat-card">
        <div class="value">{{ "%.3f"|format(analysis.silhouette_score) if analysis.silhouette_score is not none else "N/A" }}</div>
        <div class="label">Silhouette Score</div>
    </div>
    <div class="stat-card">
        <div class="value">{{ analysis.num_rows }}</div>
        <div class="label">Data Points</div>
    </div>
    <div class="stat-card">
        <div class="value">{{ analysis.feature_names|length }}</div>
        <div class="label">Features Used</div>
    </div>
    <div class="stat-card">
        <div class="value">{{ analysis.anomaly_labels|select("equalto", 1)|list|length }}</div>
        <div class="label">Anomalies</div>
    </div>
</div>

<!-- Cluster profiles -->
<details>
    <summary><strong>Cluster Profiles</strong></summary>
    <div class="cluster-profiles">
        {% for profile in analysis.cluster_profiles %}
        <div class="cluster-profile">
            <h4>Cluster {{ profile.cluster_id }}
                {% if profile.cluster_id == -1 %}(Noise){% endif %}
                â€” {{ profile.size }} samples ({{ profile.percentage }}%)
            </h4>
            {% if profile.top_features %}
            <table>
                <thead>
                    <tr>
                        <th>Feature</th>
                        <th>Cluster Mean</th>
                        <th>Overall Mean</th>
                        <th>Deviation</th>
                    </tr>
                </thead>
                <tbody>
                    {% for feat in profile.top_features %}
                    <tr>
                        <td>{{ feat.feature }}</td>
                        <td>{{ feat.cluster_mean }}</td>
                        <td>{{ feat.overall_mean }}</td>
                        <td>{{ feat.z_deviation }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</details>

<!-- Charts -->
<h3>Visualizations</h3>
{% include "partials/cluster_charts.html" %}

<!-- Save button -->
<div style="margin-top: 2rem; text-align: center;">
    <button hx-post="/api/analysis/{{ analysis.id }}/save"
            hx-target="#save-status"
            hx-swap="innerHTML">
        Save Analysis
    </button>
    <div id="save-status" style="margin-top: 1rem;"></div>
</div>
