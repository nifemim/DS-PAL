<h3>Dataset Preview: {{ preview.name }}</h3>
<p>{{ preview.num_rows }} rows &times; {{ preview.num_columns }} columns
    ({{ preview.numeric_columns|length }} numeric{% if preview.categorical_columns %}, {{ preview.categorical_columns|length }} categorical{% endif %})</p>

<!-- Column info -->
<details>
    <summary>Column Details</summary>
    <div class="preview-table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Column</th>
                    <th>Type</th>
                    <th>Non-null</th>
                    <th>Missing</th>
                    <th>Sample Values</th>
                </tr>
            </thead>
            <tbody>
                {% for col in preview.columns %}
                <tr>
                    <td>{{ col.name }}</td>
                    <td><code>{{ col.dtype }}</code></td>
                    <td>{{ col.non_null_count }}</td>
                    <td>{{ col.null_count }}</td>
                    <td>{{ col.sample_values|join(", ") }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</details>

<!-- Sample rows -->
<details>
    <summary>Sample Rows</summary>
    <div class="preview-table-wrapper">
        <table>
            <thead>
                <tr>
                    {% for col in preview.columns %}
                    <th>{{ col.name }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for row in preview.sample_rows %}
                <tr>
                    {% for col in preview.columns %}
                    <td>{{ row[col.name] }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</details>

<!-- Analysis config form -->
<form class="config-form"
      hx-post="/api/analyze"
      hx-target="#analysis-results"
      hx-indicator="#analysis-spinner">

    <input type="hidden" name="source" value="{{ preview.source }}">
    <input type="hidden" name="dataset_id" value="{{ preview.dataset_id }}">
    <input type="hidden" name="name" value="{{ preview.name }}">
    <input type="hidden" name="url" value="{{ preview.url }}">

    <h4>Analysis Configuration</h4>

    <label for="algorithm">Clustering Algorithm</label>
    <select name="algorithm" id="algorithm">
        <option value="kmeans" selected>K-Means</option>
        <option value="dbscan">DBSCAN</option>
        <option value="hierarchical">Hierarchical (Agglomerative)</option>
    </select>

    <label for="n_clusters">Number of Clusters (leave empty for auto-detection)</label>
    <input type="number" name="n_clusters" id="n_clusters" min="2" max="20"
           placeholder="Auto-detect">

    <label for="contamination">Anomaly Contamination Rate</label>
    <input type="range" name="contamination" id="contamination"
           min="0.01" max="0.3" step="0.01" value="0.05">
    <small>5% — proportion of data expected to be anomalous</small>

    <fieldset>
        <legend>Numeric Columns</legend>
        <div class="column-select">
            {% for col in preview.numeric_columns %}
            <label>
                <input type="checkbox" name="columns" value="{{ col }}" checked>
                {{ col }}
            </label>
            {% endfor %}
        </div>
    </fieldset>

    {% if preview.categorical_columns %}
    <fieldset>
        <legend>Categorical Columns (will be encoded)</legend>
        <div class="column-select">
            {% for col in preview.columns %}
                {% if col.name in preview.categorical_columns %}
                <label>
                    <input type="checkbox" name="categorical_columns" value="{{ col.name }}" checked>
                    {{ col.name }}
                    <small>{{ col.cardinality }} unique — {{ col.suggested_encoding }}
                        {% if col.suggested_encoding == "label" %}
                        <em>(assumes ordinal order)</em>
                        {% endif %}
                    </small>
                </label>
                {% endif %}
            {% endfor %}
            {% for col in preview.columns %}
                {% if col.is_id_like %}
                <label class="disabled">
                    <input type="checkbox" disabled>
                    {{ col.name }}
                    <small>excluded (ID-like, {{ col.cardinality }} unique)</small>
                </label>
                {% endif %}
            {% endfor %}
        </div>
    </fieldset>
    {% endif %}

    <button type="submit">Run Analysis</button>
</form>

<div id="analysis-spinner" class="htmx-indicator">
    <p aria-busy="true">Running analysis... This may take a moment for large datasets.</p>
</div>
