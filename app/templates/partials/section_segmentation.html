<h3>Segmentation</h3>

<!-- Algorithm and params -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="value">{{ analysis.algorithm|upper }}</div>
        <div class="label">Algorithm</div>
    </div>
    <div class="stat-card">
        <div class="value">{{ analysis.n_clusters }}</div>
        <div class="label">Clusters Found</div>
    </div>
    <div class="stat-card">
        <div class="value">{{ "%.3f"|format(analysis.silhouette_score) if analysis.silhouette_score is not none else "N/A" }}</div>
        <div class="label">Silhouette Score</div>
    </div>
</div>

{% if analysis.params %}
<details>
    <summary><strong>Algorithm Parameters</strong></summary>
    <table>
        <thead>
            <tr>
                <th>Parameter</th>
                <th>Value</th>
            </tr>
        </thead>
        <tbody>
            {% for key, val in analysis.params.items() %}
            <tr>
                <td>{{ key }}</td>
                <td>{{ val }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</details>
{% endif %}

<!-- Cluster profiles -->
<details>
    <summary><strong>Cluster Profiles</strong></summary>
    <div class="cluster-profiles">
        {% for profile in analysis.cluster_profiles %}
        <div class="cluster-profile">
            <h4>Cluster {{ profile.cluster_id }}
                {% if profile.cluster_id == -1 %}(Noise){% endif %}
                â€” {{ profile.size }} samples ({{ profile.percentage }}%)
            </h4>
            {% if profile.top_features %}
            <table>
                <thead>
                    <tr>
                        <th>Feature</th>
                        <th>Cluster Mean</th>
                        <th>Overall Mean</th>
                        <th>Deviation</th>
                    </tr>
                </thead>
                <tbody>
                    {% for feat in profile.top_features %}
                    <tr>
                        <td>{{ feat.feature }}</td>
                        <td>{{ feat.cluster_mean }}</td>
                        <td>{{ feat.overall_mean }}</td>
                        <td>{{ feat.z_deviation }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</details>

<!-- Segmentation charts -->
<div class="charts-grid">
    {% for chart in charts if chart.chart_type in ["scatter_2d", "scatter_3d", "cluster_sizes", "silhouette", "parallel_coordinates"] %}
    <div class="chart-container">
        <h4>{{ chart.title }}</h4>
        <div data-plotly='{{ chart.plotly_json }}' class="chart-plot">
            {{ chart.html|safe }}
        </div>
    </div>
    {% endfor %}
</div>
